{% extends "home-header.html" %}

{% block script %}

{#
 <script src="https://unpkg.com/video.js/dist/video.js"></script>
 <script src="https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.js"></script>
#}
<script>

async function worker_job(msg) {
    let worker = new Worker("{{ url_for('static', filename='worker.js')}}");
    
    return new Promise( resolve => {
        worker.postMessage(JSON.stringify(msg));

        worker.onmessage = (e) => {
            console.log(e);
            resolve(e.data);
        }
    });
}


audio_div = `
<audio hidden controls id="audio_div_A" onended="next()"> </audio>
<audio hidden controls id="audio_div_B" onended="next()"> </audio>
<div height=100%> <button onclick="next()">Next</button> </div>
`
function set_next_song( adiv, autoplay ) {
    msg = {type: "random" }
    worker_job(msg).then(data => {
        adiv.src = data;
        if (autoplay)
            adiv.play();
    });
}

function play(){
    player = document.getElementById("player");
    player.innerHTML = audio_div;

    aA = player.querySelector("#audio_div_A");
    aB = player.querySelector("#audio_div_B");

    aA.hidden = false;

    console.log("A");
    set_next_song(aA, true);
    set_next_song(aB, false);

    console.log("B");
}

current="A"
function next() {
    player = document.getElementById("player");
    aA = player.querySelector("#audio_div_A");
    aB = player.querySelector("#audio_div_B");

    if (current == "A") {
        current = "B"
        aA.hidden = true;
        aB.hidden = false;

        set_next_song(aA, false);
        aA.pause();
        aB.play();
    } else {
        current = "A"
        aB.hidden = true;
        aA.hidden = false;
    
        set_next_song(aB, false);
        aB.pause();
        aA.play();
    }
}

{#

// Video player:
function set_vid_src( adiv, url, autoplay ) {
    msg = { 
        type: "video",
        url: url,
    }

    worker_job(msg).then(data => {
        adiv.innerHTML=`<source src="` + data + `" type="application/x-mpegURL">`;

        var jsvid = videojs("vidframe");
        if (autoplay)
            adiv.play();
    });
}

video_div = `<video-js id="vidframe" class="vjs-default-skin" controls preload="auto" width="640" height="268">
 <source src="https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8" type="application/x-mpegURL">
</video-js>`

function play_vid() {
    player = document.getElementById("player");
    player.innerHTML = video_div;

    
    vidframe = player.querySelector("#vidframe");

    console.log(vidframe);

    set_vid_src(vidframe,"https://www.twitch.tv/freestylefox?referrer=raid", false);
}

#}

</script>
{% endblock %}

{% block body %}

{# Check this out: https://developers.google.com/youtube/iframe_api_reference #} 

<div> 

{#
<label for="url_entry">Vid Url: </label>
<input type="text" id="url_entry" name="url_entry"></input>

<button onclick="play_vid()">Play Video</button>

<button onclick="play()">Play Random Music</button>
</div>
#}


<div id="player" style="margin-top: 20px">
<button onclick="play()">Play Random Music</button>
</div>

{% endblock %}
